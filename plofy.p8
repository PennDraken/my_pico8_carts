pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
function new_o(x,y,n,update)
	o={}
	o.x=x
	o.y=y
	o.w=4
	o.h=4
	o.dx=0
	o.dy=0
	o.minjv=1.5
	o.maxjv=3
	o.jcharge=0--charge for jumping
	o.maxv=1.5--max move vel
	o.ma=0.1--move acc
	o.n=n
	o.fall_time=0
	o.coyote_time=3--frames until falling
	o.dir=0
	o.draw=function(this)
		local w=this.w/8
		local flipped=false
		if this.dx<0 then
			flipped=true
		end
		if this.jcharge>0 and this.jcharge<0.8 then
			--charging jump
			spr(this.n+2,this.x,this.y,w,1,flipped)
		elseif this.jcharge>0.8 then
			spr(this.n+3,this.x,this.y,w,1,flipped)
		elseif this.dy>0 then
			spr(this.n+5,this.x,this.y,w,1,flipped)
		elseif this.dy<0 then
			spr(this.n+4,this.x,this.y,w,1,flipped)
		else
			--default
			spr(this.n+0,this.x,this.y,w,1,flipped)
		end
	end
	o.update=update--upd is a function
	return o
end

function update_player(this)
	if btn(➡️) and this.jcharge<0.1 then
		if this.dx<this.maxv then
			this.dx+=this.ma
		elseif this.dx<this.maxv+0.1 then
			this.dx=this.maxv
		else
			this.dx-=this.ma
		end
	elseif btn(⬅️) and this.jcharge<0.1 then
		if -this.dx<this.maxv then
			this.dx-=this.ma
		elseif this.dx<this.maxv+0.1 then
			this.dx=-this.maxv
		else 
			this.dx+=this.ma
		end
	else
		--decelerate to 0
		local thr=0.1
		if this.dx<-thr then
			this.dx+=this.ma
		elseif this.dx>thr then
			this.dx-=this.ma
		else
			this.dx=0
		end
	end
	
	--jumping
	if btn(❎) and this.dy==0 then
		this.jcharge=min(1,this.jcharge+0.1)
	elseif this.jcharge!=0 then
		--jumping
		this.dy=-(this.minjv+(this.maxjv-this.minjv)*this.jcharge)
		this.jcharge=0
		if btn(➡️) then
			this.dx=this.maxv
		elseif btn(⬅️) then
			this.dx=-this.maxv
		end
	end
	this.dy+=ga
	local isfalling=not map_collide_y(p)
	--increment coyote time
	if isfalling then
		this.fall_time+=1
		if this.fall_time>this.coyote_time then
			this.dy+=ga
		elseif this.dy>0 then
			this.dy=0
		end
	else
	 this.fall_time=0
	end
	
	map_collide_x(p)
	
	--update player pos
	this.x+=this.dx
	this.y+=this.dy
	
end

function map_collide_y(o)
	local mx1 = flr(o.x / 8)
	local mx2 = flr((o.x + o.w - 1) / 8)
	
	
	if o.dy > 0 then
		-- moving down: check tiles below
		local my = flr((o.y + o.h) / 8)
		if fget(mget(mx, my1),1) then
			p.dy=-4
			return true
		end
		if fget(mget(mx1, my),0) or fget(mget(mx2, my),0) then
			o.y = my * 8 - o.h
			o.dy = 0
			return true
		end
	elseif o.dy < 0 then
		-- moving up: check tiles above
		local my = flr(o.y / 8)
		if fget(mget(mx1, my),0) or fget(mget(mx2, my),0) then
			o.y = (my + 1) * 8
			o.dy = 0
			return true
		end
	else
		return false
	end
end

function map_collide_x(o)
	local my1 = flr(o.y / 8)
	local my2 = flr((o.y + o.h - 1) / 8)
	
	if o.dx > 0 then
		-- moving right
		local mx = flr((o.x + o.w) / 8)
		if fget(mget(mx, my1)) == 1 or fget(mget(mx, my2)) == 1 then
			o.x=mx * 8 - o.w
			o.dx=0---o.dx*1
		end
	elseif o.dx < 0 then
		-- moving left
		local mx = flr((o.x - 1) / 8) -- fix here!
		if fget(mget(mx, my1)) == 1 or fget(mget(mx, my2)) == 1 then
			o.x=(mx + 1) * 8
			o.dx =0---o.dx*1
		end
	end
	
end

function update_cam(this,p)
	--cam aims f frames aheaf of p
	local f=20
	local x=p.x+p.dx*f
	local y=p.y+p.dy*f
	local dx=x-this.x
	local dy=y-this.y
	local d=sqrt(dx^2+dy^2)
	if d!=0 then
		
	end
	local sf=0.04--speed factor
	this.x+=dx*sf
	this.y+=dy*sf
end

function _init()
	c={}
	c.x=0
	c.y=0
	c.update=update_cam
	ga=0.05
	p=new_o(10,10,1,update_player)
	upd=upd_game
	drw=drw_game
end

function _update60()
	upd()
end

function _draw()
 drw()
end
-->8
--draw
function drw_game()
	cls(1)
	--camera(p.x-64-p.w/2,p.y-64-p.h/2)
	camera(flr(p.x/16/8)*16*8,flr(p.y/16/8)*16*8)
	--camera(c.x-64,c.y-64)
	p:draw()
	map()
end
-->8
--update
function upd_game()
	p:update()
	--move camera
	--c:update(p)
end
__gfx__
00000000777700000000000000000000000000000777000007770000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777700007777000000000000000000000c7c000007770000000000000000000000000000000000000000000000000000000000000000000000000000
007007007c7c00007c7c000077770000000000000777000007770000000000000000000000000000000000000000000000000000000000000000000000000000
0007700077770000777700007c7c000077770000077700000c7c0000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000000000000000000000000000000777000007770000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbb313131310550055000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb00000000000
1b1b1b1b1b1b1b1b353535350550055000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb00000000000
3b3b3b3b0b0b0b0b5555555505500550000000000000000000000000000000000000000000000000000000000000000000000000000000000bb77bb000000000
33333333000000005555555505500550000000000000000000000000000000000000000000000000000000000000000000000000000000000bb77bb000000000
33333333000000005555555505500550000000000000000000000000000000000000000000000000000000000000000000000000000000b0000bb30000000000
3333333300000000555555550550055000000000000000000000000000000000000000000000000000000000000000000000b00b00000b7b000bb33000000000
33333333000000005555555505500550000000000000000000000000000000000000000000000000000000000000000000b0b00b000003b000000330b0000b00
333333330000000055555555055005500000000000000000000000000000000000000000000000000000000000000000000b00b000000300000033000b00b000
333333333333333355555555000000000bbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333333333b333335555555500000000b333333b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
333333333bbb33335555555500000000333773330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333333333b333335555555500000000337777330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333333333335555555500000000333333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333333333333b335555555500000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333333333335555555500000000777777770000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333333333335555555500000000666666660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03333330000000000555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
03333330000000000555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00333300000000000055550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00333300000000000055550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00033000000000000005500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001010100000000000000000000000000010001000300000000000000000000000000010000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000540050424200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000042525200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000540000000052526200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000052620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000052000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000540000000000000052000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000040000000000000000000000052000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000050000000000000000000000052000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000050000000000000000000000052000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000050404040404040404040000052000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000043434343434343434343000052000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000004f4f00004c00004f004d4e4f4c4f4c434343434343434343434c0052000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000454545000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000454545454500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000004040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040
