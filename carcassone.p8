pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
--init
function _init()
	gridw=16
	gridh=10
	poke(24365,1)
	m=mouse()
	tile_options=init_tiles()
	drag_tile=nil
	last_tile=nil--last clicked
	map_tiles={}
	for i=0,64 do
		for j=0,64 do
			add(map_tiles,nil)
		end
	end
end

--base tiles
--tile ids,connections,rotation
function new_tile(sprites,cons)
	tile={
		sprites=sprites,--sprites
		cons=cons,--connections west,north,east,south
		draw=function(this,x,y,r)
			spr(this.sprites[r],x  ,y)
			spr(this.sprites[r]+1,x+8,y)
			spr(this.sprites[r]+16,x  ,y+8)
			spr(this.sprites[r]+17,x+8,y+8)
		end
	}
	return tile
end

--positions a tile at a position
function pos_tile(tile,x,y,r)
	obj={
		tile=tile,
		x=x,
		y=y,
		r=r,
		draw=function(this)
			this.tile:draw(this.x,this.y,this.r)
		end,
		rotate=function(this)
			if this.r<4 then
				this.r+=1
			else
				this.r=1
			end
		end
	}
	return obj
end

--tile connection types
city="city"
grass="grass"
road="road"

--create custom tiles
function init_tiles()
	tiles={
	new_tile({0,2,4,6},
										{grass,grass,city,city}),
	new_tile({8,10,12,14},
										{grass,grass,city,city}),
	new_tile({36,38,40,42},
										{grass,grass,city,city})
	}
	return tiles
end

function mouse()
	m={}
	m.x=0
	m.y=0
	m.lclick=false
	m.lheld=false
	m.draw=function(this)
		spr(192,this.x,this.y)
	end
	
	m.update=function(this)
		this.x=stat(32)
		this.y=stat(33)
		if stat(34)==1 then
			if this.lclick==false and this.lheld==false then
				this.lclick=true
			elseif this.lclick==true then
				this.lclick=false
				this.lheld=true
			end
		else
			this.lclick=false
			this.lheld=false
		end
	end
	return m
end
-->8
--draw
function _draw()
	cls(11)
	draw_tile_options()
	draw_tile_map()
	if drag_tile!=nil then
		drag_tile:draw(m.x,m.y,1)
	end
	if last_tile!=nil then
		local x=last_tile.x
		local y=last_tile.y
		spr(193,x+16,y+16)--r symbol
	end
	m:draw()
end

--draws the tiles that can be dragged
function draw_tile_options()
	for i,tile in pairs(tile_options) do
		local y=128-16
		tile:draw((i-1)*16,y,1)
	end
end

--draws all tiles placed on map
function draw_tile_map()
	for obj in all(map_tiles) do
		obj:draw()
	end
end
-->8
--update
function _update()
	m:update()
	if stat(34)==1 then
		check_click_tile()
		if m.lclick then
			check_click_rotate()
		end
	else
		--l click release
		if drag_tile!=nil and m.y<112 then
			--place tile
			obj=pos_tile(drag_tile,m.x,m.y,1)
			add(map_tiles,obj)
			last_tile=obj
		end
		drag_tile=nil
	end
end

function check_click_tile()
	if (drag_tile!=nil) return
	--menu
	for i,tile in pairs(tile_options) do
		x=(i-1)*16
		y=128-16
		if m.x>x and m.x<x+16 and
					m.y>y and m.y<y+16 then
			drag_tile=tile
			break
		end
	end
	--map
	for obj in all(map_tiles) do
		local x=obj.x
		local y=obj.y
		if m.x>x and m.x<x+16 and
					m.y>y and m.y<y+16 then
			drag_tile=obj.tile
			last_tile=nil
			del(map_tiles,obj)
			break
		end
	end
end

function check_click_rotate()
	if last_tile!=nil then
		local x=last_tile.x+16
		local y=last_tile.y+16
		if m.x>x and m.x<x+8 and
					m.y>y and m.y<y+8 then
			last_tile:rotate()
		end
	end
end
__gfx__
0000000000000dc00cd00000000000000000000000000dc00cd000000000000000000000000dc0000000000000000000000cd000000000000000000000000000
000000000000ddccccdd000000000000000000000000ddccccdd0000000000000000000000ddcc00000000000000000000ccdd00000000000000000000000000
000000000000dccccccd000000000000000000000000dccccccd0000000000000000000000dccc77770000000000007777cccd00000000000000000000000000
0000000000077cc77cc77000000000000000000000077cc77cc770000000000000000000006cc77777dc00000000dc77777cc600000000000000000000000000
000000000077677777767700000000008888888888776777777677888888888800000000006777667ddcc888888ddcc766777600000000000000000000000000
000000000776677777766770000000008888888887766777777667788888888800000000007777666dccc788887dccc666777700000000000000000000000000
0000000077668778877866770000000088888888776607700770667788888888000000000777688866cc77777776cc7688867770000000000000000000000000
000000077668888888888667700000008888888776600000000006677888888800000000077668880677767777667770888667700000000000dc00000000dc00
00000077668888888888886677000000888888776600000000000066778888880000000007768888067776666666777088886770000000000ddcc077770ddcc0
0dc00776688888888888888667700cd08dc88776600000000000000667788cd800000000077dc8880077006666007700888cd770000000006dccc777777dccc0
ddcc776688888888888888886677ccddddcc776600000000000000006677ccdd0000000007ddcc88000000000000000088ccdd700000000066cc77666676cc70
dccc766888888888888888888667cccddccc766000000000000000000667cccd0000000007dccc77000000000000000077cccd70000000000677766666667770
6cc76688888888888888888888667cc66cc76600000000000000000000667cc600000000066cc7770000000000000000777cc660000000000677768888667770
67776888888888888888888888867776677760000000000000000000000677760000000006677766000000000000000066777660000000000077888888887700
67778888888888888888888888887776677700000000000000000000000077760000000000677766000000000000000066777600000000000776888888886770
07788888888888888888888888888771177000000000000000000000000007710000000000077000000000000000000000077000000000000776888888886770
00000000000000000000000ff000000000000000000000000000000ff00000000000000ff0000000000000000000000000000000000000000000000000000000
00000000000000000000000ff000000000000000000000000000000ff00000000000000ff0000000000000000000000000000000000000000000000000000000
00000000000000000000000ff000000000000000000000000000000ff00000000000000ff0000000000000000000000000000000000000000000000000000000
00000000000000000000000ff000000000000000000000000000000ff00000000000000ff0000000000000000000000000000000000000000000000000000000
00000000000000000000000ff000000000000000000000000000000ff00000000000000ff0000000000000000000000000000000000000008888888888888888
00000000000000000000000ff000000000000000000000000000000ff00000000000000ff0000000000000000000000000000000000000008888888888888888
00000000000000000000000ff000000000000000000000000000000ff00000000000000ff0000000000000000000000000000000000000008888888888888888
ffffffffffffffff0000000ff0000000fffffffff0000000fffffffff00000000000000fffffffff0000000fffffffff00000000000000008888888888888888
ffffffffffffffff0000000ff0000000fffffffff0000000fffffffff00000000000000fffffffff0000000fffffffff00000000000000008888888888888888
00000000000000000000000ff00000000000000ff0000000000000000000000000000000000000000000000ff000000000000000000000008888888888888888
00000000000000000000000ff00000000000000ff0000000000000000000000000000000000000000000000ff000000000000000000000008888888888888888
00000000000000000000000ff00000000000000ff0000000000000000000000000000000000000000000000ff000000000000000000000008888888888888888
00000000000000000000000ff00000000000000ff0000000000000000000000000000000000000000000000ff000000000000000000000008888888888888888
00000000000000000000000ff00000000000000ff0000000000000000000000000000000000000000000000ff000000000000000000000008888888888888888
00000000000000000000000ff00000000000000ff0000000000000000000000000000000000000000000000ff000000000000000000000008888888888888888
00000000000000000000000ff00000000000000ff0000000000000000000000000000000000000000000000ff000000000000000000000008888888888888888
0dc0000000000dc00dc0000000000dc00dc0000000000dc01dc0000000001dc01dc0000000001dc01dc0000000001dc01dc0000000001dc01dc0000000001dc0
ddcc00000000ddccddcc00000000ddccddcc00000000ddccddcc00000000ddccddcc00000000ddccddcc00000000ddccddcc00000000ddccddcc00000000ddcc
dccc77777777dcccdccc77777777dcccdccc77777777dcccdccc00000000dcccdccc00000000dcccdccc00000000dcccdccc00000000dcccdccc00000000dccc
6cc7777777776cc76cc7777777776cc76cc7777777776cc76cc7000000006cc76cc7000000006cc76cc7000000006cc76cc7000000006cc76cc7000000006cc7
67776666666667776777666666666777677766666666677767771111111167776777111111116777677711111111677767771111111167776777111111116777
67776666666667776777666666666777677766666666677767770000000067776777000000006777677700000000677767770000000067776777000000006777
17700000000007711770000000000771177000000000077117700000000007711770000000000771177000000000077117700000000007711770000000000771
17700000000007711770000000000771177000000000077110000000000000011000000000000001100000000000000110000000000000011000000000000001
17700000000007711770000000000771177000000000077110000000000000011000000000000001100000000000000110000000000000011000000000000001
1dc0000000000dc11dc0000000000dc11dc0000000000dc11dc0000000001dc11dc0000000001dc11dc0000000001dc11dc0000000001dc11dc0000000001dc1
ddcc00000000ddccddcc00000000ddccddcc00000000ddccddcc00000000ddccddcc00000000ddccddcc00000000ddccddcc00000000ddccddcc00000000ddcc
dccc77777777dcccdccc77777777dcccdccc77777777dcccdccc00000000dcccdccc00000000dcccdccc00000000dcccdccc00000000dcccdccc00000000dccc
6cc7777777776cc76cc7777777776cc76cc7777777776cc76cc7000000006cc76cc7000000006cc76cc7000000006cc76cc7000000006cc76cc7000000006cc7
67776666666667776777666666666777677766666666677767770000000067776777000000006777677700000000677767770000000067776777000000006777
67776666666667776777666666666777677766666666677767770000000067776777000000006777677700000000677767770000000067776777000000006777
17711111111117711771111111111771177111111111177117711111111117711771111111111771177111111111177117711111111117711771111111111771
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bb5555555555555555555555555555bb55bbbbbbbbbbbbbbbbbbbbbbbbbbbb550000000000000000000000000000000000000000000000000000000000000000
bbbb555555555555555555555555bbbb5555bbbbbbbbbbbbbbbbbbbbbbbb55550000000000000000000000000000000000000000000000000000000000000000
bbbbbb55555555555555555555bbbbbb555555bbbbbbbbbbbbbbbbbbbb5555550000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb5555555555555555bbbbbbbb55555555bbbbbbbbbbbbbbbb555555550000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbb555555555555bbbbbbbbbb5555555555bbbbbbbbbbbb55555555550000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbb55555555bbbbbbbbbbbb555555555555bbbbbbbb5555555555550000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbb5555bbbbbbbbbbbbbb55555555555555bbbb555555555555550000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb555555555555555555555555555555550000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66000000000000000000000000000066000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66660000000000000000000000006666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55666600000000000000000000666655000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55556666000000000000000066665555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555566660000000000006666555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5555555566660000000066665555555555bbbbbbbbbbbbbbbbbbbbbbbbbbbb550000000000000000000000000000000000000000000000000000000000000000
bb5555555566660000666655555555bb5555bbbbbbbbbbbbbbbbbbbbbbbb55550000000000000000000000000000000000000000000000000000000000000000
bbbb555555556666666655555555bbbb555555bbbbbbbbbbbbbbbbbbbb5555550000000000000000000000000000000000000000000000000000000000000000
bbbbbb55555555666655555555bbbbbb55555555bbbbbbbbbbbbbbbb555555550000000000000000000000000000000000000000000000000000000000000000
bbbbbbbb5555555555555555bbbbbbbb5555555555bbbbbbbbbbbb55555555550000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbb555555555555bbbbbbbbbb555555555555bbbbbbbb5555555555550000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbb55555555bbbbbbbbbbbb55555555555555bbbb555555555555550000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbb5555bbbbbbbbbbbbbb555555555555555555555555555555550000000000000000000000000000000000000000000000000000000000000000
01110000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
17771000177777710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
17711000111111710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
17171000171111710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01111000777111710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000171111710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000177777710000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
