pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
--init
function _init()
	poke(0x5f2d,1)--mouse listen
	m=mouse()
	ui={}
	add(ui,new_knob(0,0,"osc"))
	add(ui,new_knob(32,0,"filter"))
end


-->8
--update
a=0
function _update60()
	m:update()
	m.n=64
	--tune
	play(0,50,5,flr(rnd(7)),"wave 1")
	--mouse input
	--left click
	if m.left_click then
		for o in all(ui) do
			o:left_click()
		end
	elseif m.left_hold then
		for o in all(ui) do
			o:left_hold()
		end
	else
		--mouse not pressed
		for o in all(ui) do
			o.selected=false
			if o:hover() then
				m.n=66--set mouse to hvr
			end
		end
	end
	a+=0.01
end
-->8
--draw
function _draw()
	cls()
	for o in all(ui) do
		o:draw()
	end
	m:draw()
end
-->8
--mouse
function mouse()
	m={}
	m.lastx=nil
	m.lasty=nil
	m.x=stat(32)
	m.y=stat(33)
	m.dx=nil
	m.dy=nil
	m.n=64--sprite n
	m.left_click=false
	m.left_hold=false
	m.right_click=false

	m.draw=function(this)
		spr(this.n,this.x,this.y)
	end
	m.update=function(this)
		--position
		this.lastx=this.x
		this.lasty=this.y
		this.x=stat(32)
		this.y=stat(33)
		this.dx=this.x-this.lastx
		this.dy=this.y-this.lasty
		--mouse buttons
		if stat(34)*0b1==1 then
			if not this.left_click and not this.left_hold then
				this.left_click=true
			else
				this.left_click=false
				this.left_hold=true
			end
		else
			this.left_click=false
			this.left_hold=false
		end
	end
	return m
end
-->8
--knob
--x,y,sprite n
function new_knob(x,y,txt)
	o={}
	o.x=x
	o.y=y
	o.w=16
	o.h=16
	o.txt=txt
	o.selected=false
	o.value=0
	o.draw=function(o)
		sspr(0,0,o.w,o.h,o.x,o.y)
		local angle=-o.value*0.75+0.625
		local dx=cos(angle)*o.w/2*0.5
		local dy=sin(angle)*o.h/2*0.5
		local r=3
		circ(o.x+o.w/2+dx,o.y+o.h/2+dy,2,3)
		print(o.txt,o.x+o.w/2-#o.txt*2,o.y+o.h,7)
	end
	--checks if mouse overlaps knob
	o.hover=function(o)
		return m.x>o.x and m.x<o.x+o.w and m.y>o.y and m.y<o.y+o.h		
	end
	o.left_click=function(o)
		--check inside knob/ selected
		if o:hover() then
			--update mouse type
			m.n=65
			o.selected=true
		end
	end
	o.left_hold=function(o)
		--check inside knob/ selected
		if o.selected then
			--update mouse type
			m.n=65
			o.selected=true
			--calculate
			o.value=(o.value+(m.dx/o.w))
			if (o.value>1) o.value=1
			if (o.value<0) o.value=0
		end
	end
	return o
end


-->8
--player
local state={}
--tone,
--
function play(form,freq,vol,typ,ch)
 local id=state[ch]
 if not id then
  id=flr(rnd(4))
  for k,v in pairs(state) do
   if v==id then state[k]=nil end
  end
 end 
 state[ch]=id
 local n=63-id
 local p=0x3200+68*n
 poke(p,band(freq,63)+band(form,3)*64)
 poke(p+1,band(vol,7)*2+band(form,4)/4)
 poke(p+2,band(typ,7)*2+band(form,4)/4)

 poke2(p+66,256)
 sfx(n,id)
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000777777000000000077777700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00007000000700000000700000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00070000000070000007000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700000000007000070000000000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000700700000000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000700700000000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000700700000000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000700700000000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000700700000000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07000000000000700700000000000070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700000000007000070000000000700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00070000000070000007000000007000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00107000000701000010700000070100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01000777777000100100077777700010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
777000000c0c0000ccc0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77000000c000c000cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
700000000c0c0000c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
010100003237032370313703137030370302702f2702f2702e2602e2602d2502d2402c2402b2402a24029240282502825027250262502525025250242502324023240222302123021230202201f2201f2201e230
010100200c000180000c000180000c000180000c000180000c000180000c000180000c000180000c000180000c000180000c000180000c000180000c000180000c000180000c000180000c000180000c00018000
9301000318000300003c0001800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
