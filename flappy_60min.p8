pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
--init
cartdata("flappy_60min")

new_p=function(x,y)
	p={}
	p.x=x
	p.y=y
	p.dy=0--velocity
	p.d=8
	p.id=1
	
	p.draw=function(this)
		local thrv=0.4--threshold for changing
																--sprite change
		if this.dy<-thrv then
				spr(this.id+1,this.x,this.y)
		elseif this.dy>thrv then
				spr(this.id+2,this.x,this.y)
		else
				spr(this.id,this.x,this.y)
		end
	end
	
	p.update=function(this)
		--gravity
		local ga=0.05--gravity
		local ja=2--jump velocity
		local maxv=1
		this.dy+=ga
		--move character
		if btnp(❎) then
			this.dy-=ja
			sfx(3)
		end
		--update player position
		if this.dy>0 then
				this.dy=min(maxv,this.dy)
		else
				this.dy=max(-maxv,this.dy)
		end
		this.y+=this.dy
	end
	return p
end

new_pipe=function(x,y,top)
	pipe={}
	pipe.x=x
	pipe.y=y
	pipe.w=16
	pipe.h=128
	pipe.gap=32
	pipe.top=top--dir of pipe
	
	pipe.draw=function(this)
		--upwards pointing
		spr(64,this.x,this.y+this.gap/2,2,2)
		for i=1,16 do
			spr(96,this.x,this.y+i*8+this.gap/2,2,1)
		end
	
		--downwards pointing
		spr(82,this.x,this.y-16-this.gap/2,2,2)
		for i=1,16 do
			spr(66,this.x,this.y-i*8-16-this.gap/2,2,1)
		end	
	end
	pipe.update=function(this)
		if this.x+16<0 then
			--move pipe to random new location
			this.top=rnd({false,true})
			this.x+=#pipes*64
			this.y=min(90,rnd(floory-0))
		end
		this.x-=0.5
	end
	return pipe
end

--setup game loop
function _init()
	music()

	hiscore=dget(0)
	score=0
	floory=100
	p=new_p(10,64)
	pipes={}
	lastpipe=nil
	for i=0,5 do
		add(pipes,new_pipe(128+i*64,min(90,rnd(floory-0)),rnd({false,true})))
	end
	upd=upd_game
	drw=drw_game
end

function _update60()
	upd()
end

function _draw()
	drw()
end
-->8
--draw
function drw_game()
	cls(12)
	for pipe in all(pipes) do
		pipe:draw()
	end
	--floor
	rectfill(0,floory,128,128,15)
	for i=0,16 do
		spr(68,i*8,floory)
	end
	p:draw()
	print("score:"..score,64-4.5*3,10,7)
	if hiscore>0 then
		print("hiscore:"..hiscore,64-4.5*4,16,7)
	end
end

function drw_game_over()
	cls(12)
	for pipe in all(pipes) do
		pipe:draw()
	end
	--floor
	rectfill(0,floory,128,128,15)
	for i=0,16 do
		spr(68,i*8,floory)
	end
	p:draw()
	--text
	if score>=hiscore then
		print("game over",64-4.5*4-1,20+1,1)
		print("game over",64-4.5*4,20+1,1)
		print("game over",64-4.5*4,20,7)
		print("wow! new high score:"..hiscore,64-40,30,7)
		print("press ❎ to restart:",64-10.5*4,40,7)
	else
		print("game over",64-4.5*4-1,20+1,1)
		print("game over",64-4.5*4,20+1,1)
		print("game over",64-4.5*4,20,7)
		print("score:"..score,64-4.5*3,30,7)
		print("press ❎ to restart:",64-10.5*4,40,7)
	end

end




-->8
--update
function upd_game()
	p:update()
	for pipe in all(pipes) do
		pipe:update()
		--check collision
		--x calc first
		if p.x+4>pipe.x and p.x<pipe.x+16 then
			if p.y<pipe.y-pipe.gap/2 then
				--collision
				set_game_over()
			end
			if p.y+8>pipe.y+pipe.gap/2 then
				--collision
				set_game_over()
			end
			
			--tally score
			if pipe!=last_pipe then
				last_pipe=pipe
				score+=1
			end
		end
	end
	if p.y+8>floory then
		set_game_over()
	end
end

function set_game_over()
	if score > hiscore then
		hiscore=score
		dset(0,hiscore)
	end
	upd=upd_game_over
	drw=drw_game_over
end

function upd_game_over()
	--move player to floor
	if p.y+8<floory then
		p:update()
	end
	if btnp(❎) then
		_init()
	end
end

__gfx__
000000000aaaa000000008000aaaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000aaaa6600002289809aaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700aaa677200677898a9aaaaaaa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000aaa67720a677898a9a8a66aa000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000aaaa8880aa66a8aa9898776a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007009aa899989aaaaaaa98987760000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000099aa888099aaaaaa08982200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000099999000999999000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
111111111111111101babb3b33535510111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1baaaaaababbbbb101babb3b33535510aaaaaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1babb3b33335355101babb3b33535510b33bb33b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1babb3b33335355101babb3b3353551033bb33bb0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1babb3b33335355101babb3b335355103bb33bb30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1babb3b33335355101babb3b33535510bb33bb330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
13b332333335355101babb3b33535510b33bb33b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
111111111111111101babb3b33535510111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
013b33233353551001babb3b33535510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b3353551001babb3b33535510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b3353551001babb3b33535510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b3353551001babb3b33535510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b3353551001babb3b33535510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b3353551001babb3b33535510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b3353551001babb3b33535510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b33535510013b332333535510000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101baaaaaababbbbb1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101babb3b333353551000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101babb3b333353551000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101babb3b333353551000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101babb3b333353551000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b3353551013b3323333353551000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
9d0100003e750247501b750147500d750077500275001750017500175001750007500075000750007500075000000000000000000000000000000000000000000000000000000000000000000000000000000000
5c02001a316501365026740216401f6301e6301e6101d6101d6001d6001d6001d6001d6001d6001d6001e6001d6001d6001c6001c6001c6001b6001b6001b6001b6001a6001a6001a600196001c6001b6001b600
0102000028a5523a551fa5518a0012a000ea000ba0000005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005000050000500005
000200000d05004050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
af1400202c0502703026030240302b0501000015000000000c0001000015000000000c00010000150002b05010000130001700000000100001300017000000000e0001300017000000000e00013000170002b050
0114002000050000500005000050000000000000050000501c7001070015700007000c700107001c7001d7001f70013700000500005010700137001d7001c7001a70013700177000070018700137000305000700
0114002003050030500305003050000000000002050020501c70010700157000200002050107001c7001d7000000013700020500205010700137001d7001c7000000013700030000300018700137000205000700
351400200c85000000000000000018950000000000000000000000000000000000001895000000000000000000000000000000000000189500000000000000000000000000000000000018950000000000000000
011400200c8503ca233ca543ca43189503ca533ca633ca543ca333ca333ca633ca54189500c8503ca330c9303ca333ca330c8503ca33189503ca533ca633ca543ca333ca333ca633ca54189500c8530c8543ca33
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1f1400001b05000000000000000000000000001d0501d0501f05000000000000000000000000001f0501f05022050220501f0501f0501d0501d0501b0501b05022050220501f0501f0501d0501d0501b0501b050
1f1400001b050000000000000000000000000022050220501f0500000000000000000000000000220502205022050220501f0501f0501d0501d050220502205020050200501f0501f0501d0501d0501b0501b050
a91400000005000050000500005000050000500005000050020500205002050020500205002050020500205003050030500305003050030500305003050030500305003050030500305003050030500305003050
011400000005000050000500005000050000500005000050070500705007050070500705007050070500705003050030500305003050030500305003050030500205002050020500205002050020500205002050
__music__
00 10515254
00 10525213
01 10115214
00 10125214
00 10115214
00 10125214
00 181a5214
00 191b5214
00 181a5214
02 191b5214

