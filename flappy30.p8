pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
function new_p(x,y)
	p={}
	p.x=x
	p.y=y
	p.dy=0
	p.draw=function(this)
		local thr=0.5
		if this.dy>thr then
			spr(3,this.x,this.y)
		elseif this.dy<-thr then
			spr(2,this.x,this.y)
		else
			spr(1,this.x,this.y)
		end
	end
	p.update=function(this)
		local ga=0.05
		local ja=1
		this.dy+=ga--gravity
		if btnp(❎) then
			this.dy=-ja
		end
		--clamping
		if this.dy>0 then
			this.dy=min(0.7,this.dy)
		else
		 this.dy=max(-ja,this.dy)
		end
		this.y+=this.dy
	end
	return p
end

function new_pipe(x,y)
	pipe={}
	pipe.x=x
	pipe.y=y
	pipe.draw=function(this)
		--top part of pipe
		spr(66,this.x,this.y,2,2)
		for i=1,20 do
			spr(80,this.x,this.y-i*8,2,1)
		end
		--bottom part of pipe
		spr(64,this.x,this.y+pipe_gap,2,2)
		for i=1,20 do
			spr(80,this.x,this.y+pipe_gap+i*8,2,1)
		end
	end
	pipe.update=function(this)
		this.x-=0.5
		if this.x+16<0 then
			this.x+=#pipes*pipe_d
		end
	end
	return pipe
end

function _init()
	score=0
	floory=100
	upd=upd_game
	drw=drw_game
	p=new_p(20,64)
	pipe_gap=40
	pipe_d=80
	pipes={}
	last_pipe=nil
	for i=1,10 do
		add(pipes,new_pipe(i*pipe_d,rnd_y()))
	end
end

function rnd_y()
	local d=floory-20
	return 20+rnd(d)
end

function _update60()
	upd()
end

function _draw()
	drw()
end
-->8
--draw
function drw_game()
	cls(12)
	for pipe in all(pipes) do
		pipe:draw()
	end
	--draw_floor()
	p:draw()
	print("score:"..score,64-4*4.5,20,7)
end




function drw_game_over()
	cls(12)
	for pipe in all(pipes) do
		pipe:draw()
	end
	p:draw()
	print("game over",64-4*4.5,20,7)
end
-->8
--update
function upd_game()
	p:update()
	for pipe in all(pipes) do
		pipe:update()
		if p.x+6>pipe.x and p.x<pipe.x+16 then
			--inside pipe
			if p.y<pipe.y or p.y+6>pipe.y+pipe_gap then
				--pipe collision
				set_game_over()
			end
			--keep track of score
			if last_pipe!=pipe then
				last_pipe=pipe
				score+=1
			end
		end
	end
end

function set_game_over()
	upd=upd_game_over
	drw=drw_game_over
end

function upd_game_over()

	if p.y<floory then
		p:update()
	end
end

__gfx__
00000000099999000000880000999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000999977700711880009999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700999777109777889009999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000999977109777889009999799000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000999988889979999009887779000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700999988889999999009887779000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000099999009999999000881170000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000999990000880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
111111111111111101babb3b33535510111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1aaaaaaaa3a3b33101babb3b33535510aaaaaaaa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1babb3b33335355101babb3b3353551033333bb30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1babb3b33335355101babb3b335355103333bb330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1babb3b33335355101babb3b33535510333bb3330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1babb3b33335355101babb3b3353551033bb33330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
13b335355555555101babb3b335355103bb333330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
111111111111111101babb3b33535510111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101aaaaaaaa3a3b331000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101babb3b333353551000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101babb3b333353551000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101babb3b333353551000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101babb3b333353551000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b3353551013b3353555555551000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
01babb3b335355101111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
0001000000000000003705000000000000000000000340503405032050310502f0500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
